#define _GNU_SOURCE

#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>

#define CANARY	"DontBreakMe!"
#define DC_612	"DC612 Day\0"

struct vulnerable {
	int compare;
	char buffer[128];
	char protection[12];
	char overwrite[24];
};

int main (int argc, char **argv) {

	struct vulnerable vuln;
	vuln.compare = 9;
	strncpy(vuln.protection, CANARY, sizeof(vuln.protection));
	strncpy(vuln.overwrite, DC_612, sizeof(vuln.overwrite));

	printf("%s\n\t%s\n\t%s\n\n%s",
		"Welcome to DC612 1-Day event!",
		"Stack Overflow Lvl 4",
		"Let's get a little tricky...",
		"What would you like to execute: ");

	gets(vuln.buffer);

	if (!strncmp(vuln.overwrite , DC_612, sizeof(vuln.overwrite))) {
		printf("%s\n", "Sorry try again...");
		exit(0);
	}
	if (strncmp(vuln.protection, CANARY, (vuln.compare+3))) {
		printf ("%s\n", "Beware stack protections! Sorry.");
	} else {
		printf("%s\n", "Good job, too bad it's not that easy.");
	}
	exit(0);

	gid_t gid = getegid();
	setresgid(gid, gid, gid);
	system(vuln.overwrite);
}
